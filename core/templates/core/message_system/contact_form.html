<!-- templates/core/message_system/contact_form.html -->
{% extends "core/base.html" %}
{% load static %}

{% block title %}{% if form.instance.pk %}Edit{% else %}Add{% endif %} Contact - Signalry{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto">
    <div class="mb-8">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    {% if form.instance.pk %}
                        Edit Contact
                    {% else %}
                        Add New Contact
                    {% endif %}
                </h1>
                <p class="text-gray-600 mt-2">
                    {% if form.instance.pk %}
                        Update contact information for {{ form.instance.email }}
                    {% else %}
                        Add a new contact to your email list
                    {% endif %}
                </p>
            </div>
            <a href="{% url 'message_system:contact_list' %}" 
               class="inline-flex items-center px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 font-medium">
                <i class="fas fa-arrow-left mr-2"></i> Back to Contacts
            </a>
        </div>
    </div>

    <div class="bg-white rounded-lg shadow">
        <form method="post" novalidate>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="p-4 border-l-4 border-red-500 bg-red-50">
                {% for error in form.non_field_errors %}
                <p class="text-red-700">{{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="p-6 space-y-6">
                <!-- Basic Information Section -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Basic Information</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Email -->
                        <div>
                            <label for="{{ form.email.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Email Address *
                            </label>
                            <input type="email" 
                                   name="{{ form.email.name }}" 
                                   id="{{ form.email.id_for_label }}" 
                                   value="{{ form.email.value|default:'' }}"
                                   {% if form.email.field.disabled %}disabled{% endif %}
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 {% if form.email.errors %}border-red-500{% endif %}"
                                   required>
                            {% if form.email.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.email.errors.0 }}</p>
                            {% endif %}
                            <p class="mt-1 text-xs text-gray-500">Email address must be unique</p>
                        </div>
                        
                        <!-- Status -->
                        <div>
                            <label for="{{ form.status.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Status *
                            </label>
                            <select name="{{ form.status.name }}" 
                                    id="{{ form.status.id_for_label }}"
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 {% if form.status.errors %}border-red-500{% endif %}">
                                {% for value, label in form.status.field.choices %}
                                <option value="{{ value }}" {% if form.status.value == value %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                            {% if form.status.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.status.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Personal Information Section -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Personal Information</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- First Name -->
                        <div>
                            <label for="{{ form.first_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                First Name
                            </label>
                            <input type="text" 
                                   name="{{ form.first_name.name }}" 
                                   id="{{ form.first_name.id_for_label }}" 
                                   value="{{ form.first_name.value|default:'' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 {% if form.first_name.errors %}border-red-500{% endif %}">
                            {% if form.first_name.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.first_name.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <!-- Last Name -->
                        <div>
                            <label for="{{ form.last_name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Last Name
                            </label>
                            <input type="text" 
                                   name="{{ form.last_name.name }}" 
                                   id="{{ form.last_name.id_for_label }}" 
                                   value="{{ form.last_name.value|default:'' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 {% if form.last_name.errors %}border-red-500{% endif %}">
                            {% if form.last_name.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.last_name.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Contact Details Section -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Contact Details</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Phone -->
                        <div>
                            <label for="{{ form.phone.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Phone Number
                            </label>
                            <input type="tel" 
                                   name="{{ form.phone.name }}" 
                                   id="{{ form.phone.id_for_label }}" 
                                   value="{{ form.phone.value|default:'' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 {% if form.phone.errors %}border-red-500{% endif %}">
                            {% if form.phone.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.phone.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                        <!-- Company -->
                        <div>
                            <label for="{{ form.company.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                                Company
                            </label>
                            <input type="text" 
                                   name="{{ form.company.name }}" 
                                   id="{{ form.company.id_for_label }}" 
                                   value="{{ form.company.value|default:'' }}"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 {% if form.company.errors %}border-red-500{% endif %}">
                            {% if form.company.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.company.errors.0 }}</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <!-- Tags and Groups Section -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Organization</h2>
                    
                    <!-- Tags -->
                    <div class="mb-6">
                        <label for="{{ form.tags.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Tags
                        </label>
                        <input type="text" 
                               name="{{ form.tags.name }}" 
                               id="{{ form.tags.id_for_label }}" 
                               value="{{ form.tags.value|default:'' }}"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 {% if form.tags.errors %}border-red-500{% endif %}"
                               placeholder="customer, vip, newsletter, etc.">
                        {% if form.tags.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.tags.errors.0 }}</p>
                        {% endif %}
                        <p class="mt-1 text-xs text-gray-500">Comma-separated tags for easy categorization</p>
                    </div>
                    
                    <!-- Groups -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">
                            Contact Groups
                        </label>
                        
                        {% if form.groups.field.queryset.exists %}
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                            {% for checkbox in form.groups %}
                            <div class="flex items-center">
                                <input type="checkbox" 
                                       name="{{ checkbox.data.name }}" 
                                       value="{{ checkbox.data.value }}" 
                                       id="{{ checkbox.id_for_label }}"
                                       {% if checkbox.data.selected %}checked{% endif %}
                                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                <label for="{{ checkbox.id_for_label }}" class="ml-2 text-sm text-gray-700">
                                    {{ checkbox.choice_label }}
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700">
                                        No contact groups found. 
                                        <a href="{% url 'message_system:contactgroup_create' %}" class="font-medium underline text-yellow-700 hover:text-yellow-600">
                                            Create your first group
                                        </a>
                                        to organize contacts.
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if form.groups.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.groups.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Notes Section -->
                <div>
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Additional Information</h2>
                    
                    <!-- Notes -->
                    <div>
                        <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                            Notes
                        </label>
                        <textarea name="{{ form.notes.name }}" 
                                  id="{{ form.notes.id_for_label }}" 
                                  rows="4"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 {% if form.notes.errors %}border-red-500{% endif %}"
                                  placeholder="Add any additional information about this contact...">{{ form.notes.value|default:'' }}</textarea>
                        {% if form.notes.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.notes.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Form Actions -->
                <div class="pt-6 border-t">
                    <div class="flex justify-end space-x-4">
                        <a href="{% if form.instance.pk %}{% url 'message_system:contact_detail' form.instance.pk %}{% else %}{% url 'message_system:contact_list' %}{% endif %}" 
                           class="px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 font-medium">
                            Cancel
                        </a>
                        <button type="submit" 
                                class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 font-medium">
                            {% if form.instance.pk %}
                                Update Contact
                            {% else %}
                                Create Contact
                            {% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    {% if form.instance.pk %}
    <!-- Additional Actions for Existing Contact -->
    <div class="mt-6 bg-white rounded-lg shadow">
        <div class="p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 pb-2 border-b">Contact Actions</h2>
            
            <div class="flex flex-wrap gap-3">
                <!-- View Messages -->
                <a href="{% url 'message_system:contact_detail' form.instance.pk %}#message-history" 
                   class="inline-flex items-center px-4 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200 font-medium">
                    <i class="fas fa-envelope mr-2"></i> View Messages
                </a>
                
                <!-- Send Test Email -->
                <button type="button" 
                        class="inline-flex items-center px-4 py-2 bg-blue-100 text-blue-700 rounded-md hover:bg-blue-200 font-medium"
                        onclick="alert('This feature will be implemented soon!')">
                    <i class="fas fa-paper-plane mr-2"></i> Send Test Email
                </button>
                
                <!-- Delete Contact -->
                <a href="{% url 'message_system:contact_delete' form.instance.pk %}" 
                   class="inline-flex items-center px-4 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200 font-medium">
                    <i class="fas fa-trash mr-2"></i> Delete Contact
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Format tags input to show suggestions
    const tagsInput = document.getElementById('{{ form.tags.id_for_label }}');
    const tagsData = [];
    
    // Get existing tags from the page if available
    {% if existing_tags %}
    const existingTags = {{ existing_tags|safe }};
    tagsData.push(...existingTags);
    {% endif %}
    
    // Initialize autocomplete for tags if we have data
    if (tagsData.length > 0 && tagsInput) {
        new Awesomplete(tagsInput, {
            list: tagsData,
            minChars: 1,
            maxItems: 10,
            autoFirst: true
        });
    }
});
</script>
{% endblock %}